# Скрипт автоматического обновления ПО


<img src="./git/logo.png" width=100px>

Скрипт *bimload* автоматизирует получение новых версий ПО с FTP-сервера (или http-сервера) и дальнейшую переустановку ПО. Скрипт использует средство автоматизации **Windows PowerShell** от Microsoft.

Пример вывода скрипта в терминал при успешной работе:

<img src="./git/readme/readme_terminal_pic.png" width=70%>

# Содержание

1. [Зачем](#зачем)
2. [Ввод данных](#ввод-данных)
3. [Что нужно для запуска](#что-нужно-для-запуска)
4. [Используемые технологии](#используемые-технологии)
5. [Проблемы проекта](#проблемы-проекта)

# Зачем

При разработке новые сборки ПО появляются часто. Есть польза от использования именно последней сборки. Однако неприятная рутина о скачивании, удалении и установке новой версии, а также затраты времени мешают наладить процесс по регулярной установке новой версии. Скрипт *bimload* решает такую проблему.

# Как это работает

Определение версии программ на FTP-сервере (или на http-сервере) происходит по цифре в имени **.exe*-файла. В случае изменения правил именования файлов на сервере или при изменении путей на сервере нужно внести изменения в текстовые конфигурационные файлы `*.credentials`.

Если дистрибутив уже скачан до запуска скрипта и лежит на локальном диске, скачивание не будет происходить и программа установится с диска. 

Чтобы добавить еще одну программу в список обновляемых при работе скрипта, нужно создать файл `любое_имя.credentials` и положить его в папку `/creds/`. В этом репозитории в качестве примера даны файлы в папках `/creds-ftp-sample/`и `/creds-http-sample/`, соответственно для применения с FTP-сервером и http-сервером.

Поиск и удаление программ на локальной машине устроено на основе инструмента Windows для управления Windows (WMI, Windows Management Infrastructure). 

Установка программ происходит вызовом в PowerShell вот такой вот команды:  
`C://.../дистрибутив.exe /quiet`,  
при этом лицензирование проходит штатно и в дальнейшем указания серийного номера не требуется.


### Функционал
- чтение установленных в Windows версий требуемой программы
- подключение к FTP-серверу с указанием логина и пароля (или скачивание html-страницы в случае http-сервера) и чтение доступных версий требуемой программы
- скачивание дистрибутива или использование уже скачанного ранее файла
- удаление старшей версии установленной программы
- установка новейшей сборки программы
- обновление нескольких программ в один запуск.

### Способы запуска

Скрипт запускается вручную через ярлык. Запросов к пользователю во время работы скрипта нет. Теоретически, возможно добавление в автозагрузку.

### Особенности

Во время работы скрипта переустанавливаемая программа должна быть закрыта.  

Скриншоты с различными сценариями, отработанными на тесте скрипта, см. в папке [/git/test_terminal_pics/](/git/test_terminal_pics/).



# Ввод данных

Вся настройка данных производится в текстовых файлах в папке **/creds/**. 

В репозитории хранятся примеры настроечных данных в папках **/creds-ftp-sample/** и **/creds-http-sample/**. При использовании этих файлов в работе, нужную папку нужно переименовать в **/creds/** перед использованием, а файлы в ней донастроить на собственные пути и имя сервера. 

Используется два типа настроечных файлов:
* **/creds/ftp** - файл с данными для доступа к FTP-серверу. Файл этого типа должен быть только один. При работе с http этот файл не нужен.  

    Содержимое:    
    `ftpUrl=` - адрес сервера и порт  
    `username=` - имя пользователя  
    `password=` - пароль   

* **/creds/любое_имя.credentials** - файлы с данными программы для переустановки. Этих файлов может быть любое количество. Они должны иметь расширение *.credentials*, чтобы скрипт их обнаружил.
 
    Содержимое:  
    `ftpFolder=` - адрес директории на FTP, без имени сервера, где лежит дистрибутив с программой (в случае работы с FTP-сервером)  
    `httpUrl=` - адрес html-страницы, на которой будет проводиться поиск последней версии программы (в случае работы с http-сервером). Подразумевается, что при добавлении к этому адресу имени дистрибутива (*.exe*), получится URL скачивания программы   
    `localPath=` - адрес локальной директории, где лежит или куда будет скачан дистрибутив с программой  
    `productName=` - текстовый запрос к Windows Management Instrumentation, по которому будет найдена программа (или несколько программ) для переустановки с выбором старшей версии сборки  
    `fileVersionPattern=` - регулярное выражение, по которому из имени *.exe*-файла будет определяться версия сборки. Регулярное выражение должно возвращать версию сборки в первой захваченной группе. Регистр не учитывается   
    `productVersionPattern=` - регулярное выражение, по которому из номера версии, полученному от Windows Management Instrumentation (например, *24.6677.6677*) будет определяться версия сборки (*6677*). Правила такие же, как для `fileVersionPattern`

* Паттерн для определения имени *.exe*-файла в html-странице захардкоден: 

# Что нужно для запуска

Для первого запуска нужно:

- Добавить необходимую информацию в настроечные файлы как описано выше
- Изменить путь для свойства *Объект* во вкладке *Ярлык* для ярлыка **bimload.lnk**, как указано на скриншоте. Путь должен вести к файлу **bimload_ftp.ps1** или **bimload_http.ps1**, который лежит по соседству. Путь настраивается здесь:

    <img src="./git/readme/setlnk.png" width="300">

- Проверить установку чекбокса *Запуск от имени администратора* в окне, открывающемся по нажатию на кнопку *Дополнительно*, там же. Скриншот:

    <img src="./git/readme/setlnk2.png" width="300">

- Запустить **bimload.lnk** и разрешить изменения в Windows


# Используемые технологии

* [.NET Framework](https://learn.microsoft.com/ru-ru/dotnet/framework/)
* [Windows PowerShell](https://github.com/PowerShell/PowerShell)
* [Windows Management Instrumentation (Инструментарий управления Windows)](https://learn.microsoft.com/ru-ru/windows/win32/wmisdk/wmi-start-page) 
* [Windows Script Host (Сервер сценариев Windows)](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc738350(v=ws.10))
* [File Transfer Protocol](https://datatracker.ietf.org/doc/html/rfc959)
* [Hypertext Transfer Protocol](https://httpwg.org/specs)
* [Регулярные выражения](https://learn.microsoft.com/ru-ru/dotnet/standard/base-types/regular-expression-language-quick-reference)


# Проблемы проекта

* Программа не может отследить ошибки при установке, т.к. они не выдаются в PowerShell при используемом методе установки. Для скрипта все выглядит так, будто программа установилась. Узнать, почему программа не переустановилась, можно будет только при ручном повторном запуске **.exe*. Встречались такие:
    - отсутствует необходимая версия Платформы  
    - установщик выдает "Программа уже установлена" из-за некорректного удаления предыдущей версии
    - установщик выдает "Файл не является 7z архивом", если предыдущее скачивание не было завершено до конца, и скрипт пытался установить недоскачанный файл (эта ошибка выдается явно, так что ее не пропустишь)
* Во время работы скрипт может остановить выполнение, пока в терминале не будет нажат Enter. Кажется, это происходит, когда с окна терминала снимается фокус на другое окно


# Todo

* Нет туду