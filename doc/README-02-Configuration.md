# Конфигурационные файлы

## Обзор

Bimload использует текстовые конфигурационные файлы в формате `.ini` для настройки параметров обновления каждой программы. Все конфигурационные файлы должны находиться в папке `creds/` в корне проекта.

**Примечание:** При запуске из скомпилированного exe приложение также ищет папку `creds/` в той же папке, где находится exe файл.

## Структура конфигурационного файла

Каждый `.ini` файл содержит настройки для одной программы. Файл может иметь любое имя, но должен иметь расширение `.ini`.

### Формат файла

- Каждая строка содержит пару `ключ=значение`
- Строки, начинающиеся с `#`, считаются комментариями и игнорируются
- Пустые строки игнорируются
- Порядок строк не имеет значения
- Регистр ключей не учитывается

### Пример конфигурационного файла

```ini
# Общие данные
localPath=C:\\Users\\username\\Desktop\\Distr\\NC24_heat\\
productName=BIM Отопление x64
fileVersionPattern=NCHeating241\\((\\d+)\\)_x64\\.exe
productVersionPattern=.*\\.(\\d+)$

# HTTP настройки
httpUrl=https://your-server.ru/your-distributions/NanoDists/R30/Nano20/nHeatingx64/
httpPattern=<span class="name">([^<]+)</span>
```

## Параметры конфигурации

### Общие параметры

#### `localPath`

**Описание**: Локальный путь к папке, где хранятся или будут сохранены дистрибутивы программы.

**Формат**: Путь в формате Windows с двойными обратными слешами (`\\`)

**Примеры**:
```ini
localPath=C:\\Users\\username\\Desktop\\Distr\\NC24_heat\\
localPath=D:\\Software\\Distributions\\
```

**Важно**:
- Путь должен заканчиваться обратным слешем (`\\`)
- Используйте двойные обратные слеши для экранирования
- Папка будет создана автоматически при скачивании, если не существует

#### `productName`

**Описание**: Название продукта для поиска в Windows через WMI. Используется в запросе `SELECT * FROM Win32_Product WHERE Name LIKE '%{productName}%'`.

**Формат**: Текстовая строка

**Примеры**:
```ini
productName=BIM Отопление x64
productName=SCS Professional
productName=VENT
```

**Важно**:
- Название должно совпадать с именем программы в списке установленных программ Windows
- Можно использовать частичное совпадение (WMI использует `LIKE`)
- Если установлено несколько версий, будет выбрана самая новая

#### `fileVersionPattern`

**Описание**: Регулярное выражение для извлечения версии из имени файла на сервере.

**Формат**: Регулярное выражение (regex), где версия должна быть в первой захваченной группе `(\\d+)`

**Примеры**:
```ini
# Для файла: NCHeating241(6677)_x64.exe -> версия: 6677
fileVersionPattern=NCHeating241\\((\\d+)\\)_x64\\.exe

# Для файла: SCS_24_1234.exe -> версия: 1234
fileVersionPattern=SCS_24_(\\d+)\\.exe

# Для файла: vent-2024.exe -> версия: 2024
fileVersionPattern=vent-(\\d+)\\.exe
```

**Важно**:
- Регулярное выражение должно содержать захваченную группу `(\\d+)` для номера версии
- Специальные символы должны быть экранированы (`\\(`, `\\)`, `\\.`)
- Регистр не учитывается (используется `RegexOptions.IgnoreCase`)

#### `productVersionPattern`

**Описание**: Регулярное выражение для извлечения версии из номера версии программы, полученного через WMI.

**Формат**: Регулярное выражение (regex), где версия должна быть в первой захваченной группе

**Примеры**:
```ini
# Для версии: 24.6677.6677 -> версия: 6677
productVersionPattern=.*\\.(\\d+)$

# Для версии: 1.2.3.456 -> версия: 456
productVersionPattern=.*\\.(\\d+)$

# Для версии: 2024.1 -> версия: 1
productVersionPattern=.*\\.(\\d+)$
```

**Важно**:
- WMI возвращает полный номер версии (например, `24.6677.6677`)
- Регулярное выражение должно извлечь нужную часть версии
- Обычно используется паттерн для извлечения последнего числа

### HTTP параметры

#### `httpUrl`

**Описание**: URL HTTP/HTTPS сервера, где находится HTML-страница со списком дистрибутивов.

**Формат**: Полный URL с протоколом и путем

**Примеры**:
```ini
httpUrl=https://your-server.ru/your-distributions/NanoDists/R30/Nano20/nHeatingx64/
httpUrl=http://192.168.1.100/distrs/
httpUrl=https://example.com/downloads/
```

**Важно**:
- URL должен заканчиваться слешем (`/`) для директорий
- Поддерживаются протоколы HTTP и HTTPS
- Сервер должен быть доступен без аутентификации (публичный доступ)

#### `httpPattern`

**Описание**: Регулярное выражение для поиска имен файлов в HTML-коде страницы.

**Формат**: Регулярное выражение, где имя файла должно быть в первой захваченной группе `([^<]+)`

**Примеры**:
```ini
# Для HTML: <span class="name">file.exe</span>
httpPattern=<span class="name">([^<]+)</span>

# Для HTML: <a href="distr.exe">distr.exe</a>
httpPattern=<a href="([^"]+\\.exe)">.*</a>

# Для HTML: <li>NCHeating241(6677)_x64.exe</li>
httpPattern=<li>([^<]+\\.exe)</li>
```

**Важно**:
- Регулярное выражение должно содержать захваченную группу для имени файла
- Используется последнее совпадение из всех найденных (предполагается, что файлы отсортированы)
- Имя файла должно включать расширение (обычно `.exe`)

## Полный пример конфигурационного файла

```ini
# ============================================
# Конфигурация для BIM Отопление x64
# ============================================

# Локальный путь для хранения дистрибутивов
localPath=C:\\Users\\username\\Desktop\\Distr\\NC24_heat\\

# Название продукта для поиска в Windows
productName=BIM Отопление x64

# Регулярное выражение для извлечения версии из имени файла
# Пример: NCHeating241(6677)_x64.exe -> версия: 6677
fileVersionPattern=NCHeating241\\((\\d+)\\)_x64\\.exe

# Регулярное выражение для извлечения версии из версии продукта
# Пример: 24.6677.6677 -> версия: 6677
productVersionPattern=.*\\.(\\d+)$

# HTTP настройки
httpUrl=https://your-server.ru/your-distributions/NanoDists/R30/Nano20/nHeatingx64/
httpPattern=<span class="name">([^<]+)</span>
```

## Создание нового конфигурационного файла

### Шаги:

1. **Создайте файл** с расширением `.ini` в папке `creds/`
   - Например: `my_program.ini`

2. **Заполните обязательные параметры**:
   - `localPath` — путь для хранения дистрибутивов
   - `productName` — название программы в Windows
   - `fileVersionPattern` — regex для версии из имени файла
   - `productVersionPattern` — regex для версии из версии продукта
   - `httpUrl` — URL сервера
   - `httpPattern` — regex для поиска файлов в HTML

3. **Проверьте регулярные выражения**:
   - Убедитесь, что паттерны корректно извлекают версию
   - Протестируйте на реальных данных

4. **Запустите приложение**:
   - Новый файл автоматически появится в списке программ

## Проверка конфигурации

### Типичные ошибки:

1. **Неправильный путь** (`localPath`)
   - Используйте двойные обратные слеши: `C:\\Users\\...`
   - Путь должен заканчиваться `\\`

2. **Неправильное название продукта** (`productName`)
   - Проверьте точное название в "Программы и компоненты" Windows
   - Можно использовать частичное совпадение

3. **Неправильные регулярные выражения**
   - Убедитесь, что версия находится в первой захваченной группе `(\\d+)`
   - Экранируйте специальные символы: `\\(`, `\\)`, `\\.`

4. **Неправильный URL** (`httpUrl`)
   - URL должен быть доступен без аутентификации
   - Проверьте доступность в браузере

5. **Неправильный паттерн HTML** (`httpPattern`)
   - Изучите HTML-код страницы
   - Убедитесь, что паттерн находит все файлы
   - Последний найденный файл будет использован

## Миграция с FTP на HTTP

В текущей версии приложения поддержка FTP удалена. Если у вас есть старые конфигурационные файлы с FTP-настройками:

- Удалите строки: `ftpUrl`, `ftpFolder`, `username`, `password`
- Добавьте строки: `httpUrl`, `httpPattern`
- Обновите `httpPattern` для работы с HTML-страницей вместо списка файлов FTP

## Сохранение состояния

Приложение автоматически сохраняет состояние выбранных программ в файл `update_info.json` в корне проекта. Этот файл создается автоматически и не требует ручного редактирования.

Формат файла:
```json
[
  {
    "FileName": "heat.ini",
    "IsSelected": true
  },
  {
    "FileName": "ops.ini",
    "IsSelected": false
  }
]
```


