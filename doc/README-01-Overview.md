# Bimload - Обзор проекта

## Назначение проекта

**Bimload** — это приложение для автоматического обновления программного обеспечения на Windows-машинах. Проект решает проблему рутинного процесса скачивания, удаления и установки новых версий программ, экономя время разработчиков и системных администраторов.

Приложение было переписано с PowerShell на C# (.NET 8) с использованием принципов Test-Driven Development (TDD) и современной архитектуры.

## Основной функционал

### Возможности приложения:

1. **Автоматическое обнаружение установленных программ**
   - Использование Windows Management Instrumentation (WMI) для поиска установленных программ
   - Определение текущей версии установленного ПО

2. **Получение информации о новых версиях**
   - Подключение к HTTP/HTTPS серверам для получения списка доступных дистрибутивов
   - Парсинг HTML-страниц с использованием регулярных выражений
   - Определение последней версии по имени файла

3. **Сравнение версий**
   - Автоматическое сравнение текущей и новой версий
   - Определение необходимости обновления

4. **Скачивание дистрибутивов**
   - Асинхронное скачивание файлов с HTTP/HTTPS серверов
   - Использование уже скачанных файлов при их наличии

5. **Удаление старых версий**
   - Автоматическое удаление установленных программ через WMI
   - Безопасное удаление с обработкой ошибок

6. **Установка новых версий**
   - Тихая установка программ с параметром `/quiet`
   - Ожидание завершения процесса установки

7. **Пакетное обновление**
   - Возможность обновления нескольких программ за один запуск
   - Выборочное обновление через чекбоксы

8. **Сохранение состояния**
   - Сохранение выбранных программ для обновления
   - Восстановление состояния при следующем запуске

## Описание пользовательского интерфейса

### Главное окно приложения

Графический интерфейс построен на базе **Windows Forms** и состоит из следующих элементов:

#### 1. Таблица программ (DataGridView)

Верхняя часть окна содержит таблицу со списком всех программ, доступных для обновления:

- **Чекбокс** (первая колонка) — выбор программы для обновления
  - Можно выбрать/снять выбор двойным кликом по строке
  - Кнопка "Выбрать все" переключает состояние всех чекбоксов

- **Файл конфигурации** — имя `.ini` файла с настройками программы

- **Название продукта** — название программы, как оно указано в конфигурации

- **Текущая версия** — версия, установленная на компьютере (заполняется после обновления)

- **Новая версия** — версия, доступная на сервере (заполняется после обновления)

- **Статус** — текущее состояние программы:
  - `Ожидание` — программа готова к обновлению
  - `Обновляется...` — идет процесс обновления
  - `Программа обновлена` — обновление успешно завершено
  - `Обновление не требуется` — версия актуальна
  - `Ошибка: ...` — произошла ошибка при обновлении

#### 2. Панель управления

Нижняя часть окна содержит:

- **Кнопка "Выбрать все"** — переключает выбор всех программ в таблице

- **Кнопка "Обновить"** — запускает процесс обновления выбранных программ
  - Кнопка блокируется во время обновления
  - Статус изменяется на "Выполняется обновление..."

#### 3. Лог-панель (RichTextBox)

Многострочное текстовое поле с цветным выводом логов:

- **Черный текст** — информационные сообщения
- **Зеленый текст (жирный)** — успешные операции
- **Оранжевый текст (жирный)** — предупреждения
- **Красный текст (жирный)** — ошибки

Каждое сообщение содержит временную метку в формате `[yyyy-MM-dd HH:mm:ss]`.

#### 4. Строка статуса

В самом низу окна отображается текущий статус приложения:
- `Готов к обновлению` — приложение готово к работе
- `Выполняется обновление...` — идет процесс обновления
- `Обновление завершено` — все операции завершены

### Взаимодействие с интерфейсом

1. **Запуск приложения**
   - При запуске автоматически загружаются все `.ini` файлы из папки `creds/`
   - Восстанавливается состояние выбранных программ из `update_info.json`

2. **Выбор программ**
   - Отметьте чекбоксы у программ, которые нужно обновить
   - Используйте кнопку "Выбрать все" для массового выбора/снятия выбора

3. **Запуск обновления**
   - Нажмите кнопку "Обновить"
   - Следите за процессом в лог-панели
   - Статус каждой программы обновляется в реальном времени

4. **Результат**
   - После завершения обновления статус каждой программы обновится
   - Выбранные программы сохраняются автоматически

## Работа с Windows API

### Windows Management Instrumentation (WMI)

Приложение активно использует **WMI** для работы с установленными программами в Windows.

#### Используемые WMI классы:

1. **Win32_Product**
   - Используется для поиска установленных программ
   - Запрос: `SELECT * FROM Win32_Product WHERE Name LIKE '%{productName}%'`
   - Позволяет получить:
     - `Name` — название программы
     - `Version` — версия программы
     - `InstallLocation` — путь установки

#### Основные операции с WMI:

**1. Поиск установленных программ** (`WmiService.GetLatestInstalledProgram`)

```csharp
var query = $"SELECT * FROM Win32_Product WHERE Name LIKE '%{productName}%'";
var programs = wmiQueryWrapper.GetManagementObjects(query)
    .Select(mo => new InstalledProgram
    {
        Name = mo["Name"]?.ToString(),
        Version = mo["Version"]?.ToString(),
        InstallLocation = mo["InstallLocation"]?.ToString()
    })
    .OrderByDescending(p => p.Version)
    .ToList();
```

- Выполняет WMI-запрос для поиска программ по имени
- Сортирует результаты по версии (по убыванию)
- Возвращает самую новую версию, если установлено несколько

**2. Удаление программы** (`ProgramInstaller.UninstallProgramAsync`)

```csharp
using var searcher = new ManagementObjectSearcher(
    $"SELECT * FROM Win32_Product WHERE Name = '{program.Name}'");
var collection = searcher.Get();
foreach (ManagementObject obj in collection)
{
    var result = obj.InvokeMethod("Uninstall", null);
    if (result != null && Convert.ToInt32(result) != 0)
    {
        throw new InvalidOperationException($"Uninstall failed with return code: {result}");
    }
}
```

- Находит программу по точному имени
- Вызывает метод `Uninstall()` через WMI
- Проверяет код возврата для определения успешности операции

#### Особенности работы с WMI:

- **Производительность**: WMI-запросы могут быть медленными, особенно при большом количестве установленных программ
- **Права доступа**: Для удаления программ могут потребоваться права администратора
- **Обработка ошибок**: Все WMI-операции обернуты в try-catch блоки для обработки возможных исключений

### Процессы Windows (Process API)

Для установки программ используется **System.Diagnostics.Process**:

```csharp
var processStartInfo = new ProcessStartInfo
{
    FileName = filePath,
    Arguments = "/quiet",
    UseShellExecute = false,
    CreateNoWindow = true,
    RedirectStandardOutput = true,
    RedirectStandardError = true
};

using var process = Process.Start(processStartInfo);
await process.WaitForExitAsync();
```

- **Параметр `/quiet`**: Обеспечивает тихую установку без диалоговых окон
- **CreateNoWindow = true**: Скрывает окно процесса установки
- **WaitForExitAsync()**: Асинхронное ожидание завершения установки

### HTTP API

Для работы с HTTP/HTTPS серверами используется **System.Net.Http.HttpClient**:

- Асинхронные операции загрузки
- Поддержка HTTPS
- Обработка ошибок сети
- Парсинг HTML с помощью регулярных выражений

## Порядок работы приложения

### Алгоритм обновления одной программы:

1. **Получение текущей версии**
   - WMI-запрос для поиска установленной программы
   - Извлечение версии из `Version` с помощью регулярного выражения

2. **Получение информации о новой версии**
   - HTTP-запрос к серверу для получения HTML-страницы
   - Парсинг HTML с помощью регулярного выражения для поиска файлов
   - Выбор последнего файла из списка

3. **Извлечение версии из имени файла**
   - Применение регулярного выражения к имени файла
   - Получение номера версии

4. **Сравнение версий**
   - Сравнение текущей и новой версий
   - Если версия не изменилась — пропуск обновления

5. **Скачивание дистрибутива** (если нужно)
   - Проверка наличия файла локально
   - Если файла нет — скачивание с сервера
   - Сохранение в указанную папку

6. **Удаление старой версии** (если установлена)
   - WMI-запрос для поиска программы
   - Вызов метода `Uninstall()` через WMI

7. **Установка новой версии**
   - Запуск процесса установки с параметром `/quiet`
   - Ожидание завершения установки

8. **Проверка результата**
   - Повторный WMI-запрос для проверки установки
   - Определение статуса обновления

### Пакетное обновление:

При обновлении нескольких программ:

1. Сохранение состояния выбранных программ
2. Последовательное обновление каждой выбранной программы
3. Обновление UI после каждого обновления
4. Финальное сохранение состояния

## Требования к системе

- **ОС**: Windows 10/11 или Windows Server
- **.NET**: .NET 8.0 Runtime
- **Права**: Для удаления и установки программ требуются права администратора
- **Сеть**: Доступ к HTTP/HTTPS серверам с дистрибутивами

## Ограничения и известные проблемы

1. **WMI производительность**: Запросы к WMI могут быть медленными
2. **Ошибки установки**: Некоторые ошибки установщика могут не отображаться явно
3. **Закрытие программ**: Обновляемая программа должна быть закрыта перед обновлением
4. **Только Windows**: Приложение работает только на Windows из-за использования WMI

